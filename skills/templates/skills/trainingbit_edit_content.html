{% extends 'base.html' %}
{% load staticfiles %}

{% block content %}
<div id="save-button" style="position:absolute; top: 20px; left: 30px;">
  <a class="button"><span class="icon save"></span>Save</a>
</div>


<div class="page-buttons">
  {# View trainingbit button #}
    <a href="{% url 'skills:trainingbit_view' trainingbit.id %}" class="button info">View training bit</a>
</div>

  {% include 'skills/partials/trainingbit_cover.html' %}
  <h1 class="white-on-red">1. Learn</h1>
  <div class="trainingbit-content-editor learn-section" id="learn-edit">
    <ul>
    </ul>

    <div class="row trainingbit-content-editor-toolbar">
    </div>
  </div>

  <h1 class="white-on-red">2. Act</h1>
  <div class="trainingbit-content-editor act-section" id="act-edit">
    <ul>
    </ul>

    <div class="row trainingbit-content-editor-toolbar">
    </div>
  </div>
  <h1 class="white-on-red">3. Share</h1>
  <div class="trainingbit-content-editor share-section" id="share-edit">
  </div>


  {# MODALS #}
  <div id="modal-add-link" class="reveal-modal" data-reveal>
    <h2>Add link</h2>
    <label>URL: <input class="url" type="text" placeholder="http://actionaid.org"></label>
    <label>Title: <input class="title" type="text" placeholder="The website of actionAid"></label>
    <button>Add link</button>
    <a class="close-reveal-modal">&#215;</a>
  </div>
  <div id="modal-add-embed" class="reveal-modal" data-reveal>
    <h2>Add link</h2>
    <label>Embed HTML: <textarea class="html" placeholder="Write some text here..."></textarea></label>
    <button>Add embed</button>
    <a class="close-reveal-modal">&#215;</a>
  </div>

  <form id="trainingbit-content-form" action="{% url 'skills:trainingbit_edit_content' trainingbit.id %}" method="post" enctype="multipart/form-data">
  {% csrf_token %}
    <input type="hidden" id="trainingbit_content_json" name="trainingbit_content_json">
    <button>Save training bit</button>
  </form>



  {# TEMPLATES #}
  <script type="text/template" id="section-template">
    <div class="section-content"></div>

  </script>

  <script type="text/template" id="TbPart-template">
    <div class="input-field-row">
      <div class="handle"><span class="icon arrow-combo"></span></div>
      <div class="input-field">
        <%= content %>
      </div>
      <div class="help-text">
        <%= help_text %>
      </div>
      <div class="delete">
        <a class=""><span class="icon trash"></span></a><!-- Delete -->
      </div>
    </div>
  </script>

  <script type="text/template" id="link-template">
    <span class="icon large link black"></span><a href="<%= url %>" title="<%= title %>"><%= title %></a>
  </script>
  <script type="text/template" id="link-help-text">
    <h6>Link</h6>
    Links to external websites
  </script>

  <script type="text/template" id="embed-template">
    <%= html %>
  </script>
  <script type="text/template" id="embed-help-text">
    <h6>Embed</h6>
    Videos from Youtube, Vimeo etc.
  </script>
  <script type="text/template" id="text-template">
      {# <div class="text-editor" contentEditable> #}
      <div class="text-editor text-field">
        <%= html %>
      </div>
  </script>
  <script type="text/template" id="text-help-text">
    <h6>Text</h6>
    Here you can write text.
  </script>

  <script type="text/template" id="toolbar-template">
    <div class="large-indicator">
      <div class="add-text"><span class="icon circled-plus"></span><%= name %>
      </div>
    </div>
    <ul class="small-block-grid-3 medium-block-grid-6 large-block-grid-9 small-centered">
      <li>
        <a class="add-text" href="#">
          <span class="icon medium language"></span>
          <p>Add text</p>
        </a>
      </li>
      <li>
        <a class="add-link" href="#" data-reveal-id="modal-add-link" data-reveal>
        <span class="icon medium link"></span><br>
        Add link
        </a>
      </li>
      <li>
        <a class="add-embed" href="#" data-reveal-id="modal-add-embed" data-reveal>
        <span class="icon medium video"></span>
        <p>Add embed</p>
        </a>
      </li>
        {# <span class="icon medium camera"></span> #}
        {# <span class="icon medium attach"></span> #}
    </ul>
  </script>


  {# Load dependencies #}
  <script src="http://documentcloud.github.com/underscore/underscore-min.js"></script>
  <script src="http://documentcloud.github.com/backbone/backbone.js"></script>
  {# <script src="http://documentcloud.github.com/backbone/backbone-min.js"></script> #}
  <script src="{% static 'jqueryui/jquery.ui.core.min.js' %}"></script>
  <script src="{% static 'jqueryui/jquery.ui.widget.min.js' %}"></script>
  <script src="{% static 'jqueryui/jquery.ui.mouse.min.js' %}"></script>
  <script src="{% static 'jqueryui/jquery.ui.sortable.js' %}"></script>
  <script src="{% static 'backbone/backbone.collectionView.min.js' %}"></script>
  <script src="{% static 'medium-editor/medium-editor.min.js' %}"></script>
  <link rel="stylesheet" href="{% static 'medium-editor/medium-editor.css' %}">
  {# <script src="{% static 'etch.js/scripts/etch.js' %}"></script> #}
  {# <link rel="stylesheet" href="{% static 'etch.js/styles/etch.css' %}"> #}

  <script>
{# BACKBONE MODELS #}
TbPart = Backbone.Model.extend({});

TbPartLink = TbPart.extend({
  defaults: {
    type: 'link',
    url: 'http://example.org',
    title: 'Example dot org'
  },
});

TbPartEmbed = TbPart.extend({
  defaults: {
    type: 'embed',
    html: '<embed>',
  },
});


//var lorem_ipsum = "Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum."
TbPartText = TbPart.extend({
  defaults: {
    type: 'text',
    {# html: 'Click here to start editing text', #}
    html: '',
  },
});

// a TrainingBit is a collection of TbParts
var TrainingBit = Backbone.Collection.extend({
  model: TbPart,
  parse: function (res) {
      var self = this;
      _.each(res, function (tb_part) {
        switch(tb_part.type) {
          case 'link':
            self.add(new TbPartLink(tb_part));
          case 'embed':
            self.add(new TbPartEmbed(tb_part));
          case 'text':
            self.add(new TbPartText(tb_part));
          default:
            alert('Unrecognized training bit part');
        }
      });
  }
});

// an EditorToolbar takes a TrainingBit
var EditorToolbar = Backbone.Model.extend({
  trainingbit: null
});

{# BACKBONE VIEWS #}
var TrainingBitPartView = Backbone.View.extend({

  initialize: function() {
    this.$el = $(this.el);
    this.saveTimer = null;
  },
  remove: function() {
    this.saveText();
    window.clearInterval(this.saveTimer);
  },

  //tagName: 'div',
  events: {
    'click .delete': 'deleteTbPart',
    // 'keypress .text-editor': 'saveText',
    'blur .text-editor': 'saveText',
  },

  deleteTbPart: function() {
    if (confirm('Are you sure want to remove this ' + this.model.get('type') + '?')) {
      this.model.destroy()
    }
  },

  saveText: function() {
    if (this.model.get('type') == 'text') {
      console.log('Saving text field.');
      this.model.attributes.html = this.$el.find('.text-editor').html();
    }
  },

  render: function() {
    window.clearInterval(this.saveTimer);

    console.log('Rendering TrainingBitPart');

    var type = this.model.get('type');
    console.log('of type: ' + type);


    // Render the content of the TrainingBitPart
    var content   = _.template($('#' + type + '-template').html(), this.model.toJSON());
    // Fetch the help text for the TrainingBitPart
    var help_text = $('#' + type + '-help-text').html()

    // Render the full view (with help text, drag handle, delete button ...)
    var TbPart_template =  _.template($('#TbPart-template').html());
    var rendered = TbPart_template({
      'content'  : content,
      'help_text': help_text
    });

    this.$el.html(rendered);

    // Initialize text editor
    if (type == 'text') {
      // https://github.com/daviferreira/medium-editor
      // .find('.text-editor')
      var text_editor = this.$el.find('.text-editor');
      console.log(text_editor)
      var editor = new MediumEditor(text_editor, {
          anchorInputPlaceholder: 'Type a link',
          placeholder: 'Type your text here',
          buttons: ['bold', 'italic', 'quote', 'h1', 'h2'],
          diffLeft: 0,
          diffTop: -10,
          firstHeader: 'h1',
          secondHeader: 'h2',
          delay: 300,
          targetBlank: true
      });
    }

    // Setup save timer
    var self = this;
    this.saveTimer = window.setInterval(function() {
      self.saveText();
    }, 5000);

    return this;
  }
});


var EditorToolbarView = Backbone.View.extend({
  template: _.template($('#toolbar-template').html()),

  render: function() {
    console.log(this.el);
    $(this.el).html( this.template({ name: this.options.name }) );
  },

  events: {
    'mouseover .large-indicator': 'showButtons',
    'mouseleave': 'hideButtons',
    'click .add-text': 'addText',
    'click .add-link': 'addLink',
    'click .add-embed': 'addEmbed',
 },
  showButtons: function() {
    this.$el.find('.large-indicator').fadeOut(600);
  },
  hideButtons: function() {
    this.$el.find('.large-indicator').fadeIn(600);
  },

  addText: function(e) {
    this.options.trainingbit.add(new TbPart({type: 'text', html: ''}));
    e.preventDefault();
  },

  addLink: function() {
    var self = this;
    var addLink = function() {
      console.log('Adding a link...');
      self.options.trainingbit.add(new TbPartLink({url: $('#modal-add-link input.url').val(), title: $('#modal-add-link input.title').val()}));
      $('#modal-add-link').foundation('reveal', 'close');
        $('#modal-add-link button').off('click', addLink);
    };
    $('#modal-add-link button').on('click', addLink);


    $('#modal-add-link').on('close', '[data-reveal]', function () {
      $(this).find('button').off('click', addLink);;
    });

    {# Unnecessary: $('#modal-add-link').foundation('reveal', 'open'); #}
   },

  addEmbed: function() {
    var self = this;
    var addEmbed = function() {
      console.log('Adding an embed...');
      var value = $('#modal-add-embed textarea').val();
      console.log(value);
      self.options.trainingbit.add(new TbPartEmbed({html: value}));
      $('#modal-add-embed').foundation('reveal', 'close');
      $('#modal-add-embed button').off('click', addEmbed);
    };
    $('#modal-add-embed button').on('click', addEmbed);

    $('#modal-add-embed').on('close', null, function () {
      $(this).find('button').off('click', addEmbed);;
    });

    {# Unnecessary: $('#modal-add-embed').foundation('reveal', 'open'); #}
   },
});


{# DOCUMENT LOAD: document, ready, set, go! #}
$(document).ready(function() {
  var tb = {{ trainingbit.json_content|safe }};
  var tb_learn = new TrainingBit(
    tb['learn']
  );

  if (tb_learn.length < 1) {
    tb_learn.add(new TbPartText());
  }

  //var tb_learn_view = new TrainingBitView({el: $('#learn-edit'), collection: tb_learn});
  var tb_learn_view = new Backbone.CollectionView({
    el: $('#learn-edit > ul'),
    collection: tb_learn,
    modelView: TrainingBitPartView,

    sortable: true,
    sortableOptions: {
      handle: '.handle'
    }
  });
  var tb_learn_toolbar = new EditorToolbarView({
    name: 'Add learning', // this variable is passed into the views property
                          // called `options` i.e. `this.options.name`
    el: $('#learn-edit .trainingbit-content-editor-toolbar'),
    trainingbit: tb_learn
  });
  tb_learn_view.render();
  tb_learn_toolbar.render();

  var tb_act = new TrainingBit(
    tb['act']
  );
  var tb_act_view = new Backbone.CollectionView({
    el: $('#act-edit > ul'),
    collection: tb_act,
    modelView: TrainingBitPartView,

    sortable: true,
    sortableOptions: {
      handle: '.handle'
    }
  });
  var tb_act_toolbar = new EditorToolbarView({
    name: 'Add actions', // this variable is passed into the views property
                          // called `options` i.e. `this.options.name`
    el: $('#act-edit .trainingbit-content-editor-toolbar'),
    trainingbit: tb_act
  });
  tb_act_view.render();
  tb_act_toolbar.render();

  var tb_share_text = new TbPartText({html: ''});
  var tb_share_view = new TrainingBitPartView({
    el: $('#share-edit'),
    model: tb_share_text,
  });
  tb_share_view.render();
  {# var tb_share = new TrainingBit(); #}
  {# var tb_share_view = new TrainingBitView({el: $('#share-edit'), collection: tb_share}); #}
  {# tb_share.add(new TbPartText()); #}

  $('#save-button a').click(function() {
      {# console.log(tb_learn.model.toJson()); #}
    console.log(JSON.stringify(tb_learn));
  });


  $('#trainingbit-content-form').submit(function(e) {
    {# e.preventDefault(); #}
    {# e.stopPropagation(); #}
    var tb = {
      learn: tb_learn.toJSON(),
      act: tb_act.toJSON(),
      share: tb_share_text.toJSON(),
    };
    console.log(JSON.stringify(tb));
    $(this).children('input[name=trainingbit_content_json]').val(JSON.stringify(tb));
  });

});
  </script>
{% endblock %}
